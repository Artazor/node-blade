/** Blade Run-time helper functions
	(c) Copyright 2012. Blake Miner. All rights reserved.	
	https://github.com/bminer/node-blade
	http://www.blakeminer.com/
	
	See the full license here:
		https://raw.github.com/bminer/node-blade/master/LICENSE.txt
*/(function(){function c(a,b,c){var d=a.buf.splice(c,a.buf.length-c);Array.prototype.unshift.apply(a.buf,d);for(var e in b.blocks)b.blocks[e].parent==a&&b.blocks[e].pos>=c&&(b.blocks[e].pos-=c)}function d(a,b){var c=a+" ";for(var d=0;d<b-c.length+1;d++)c=" "+c;return c}var a=typeof exports=="object"?exports:{},b={};if(a.client=typeof window!="undefined")window.blade={runtime:a,cachedViews:b,cb:{},rootURL:"/views"};a.escape=function(a){return a==null?"":(new String(a)).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},a.attrs=function(b,c){for(var d in b){if(b[d].val==null){if(b[d].append==null)continue;b[d].val=b[d].append,delete b[d].append}d=="class"&&(b[d].val instanceof Array&&(b[d].val=b[d].val.join(" ")),b[d].append&&(b[d].val=(b[d].val.length>0?b[d].val+" ":"")+b[d].append)),b[d].escape?c.push(" "+d+'="'+a.escape(b[d].val)+'"'):c.push(" "+d+'="'+b[d].val+'"')}},a.loadTemplate=function(c,d,e,f){typeof e=="function"&&(f=e,typeof d=="object"?(e=d,d=c,c=""):e=null),typeof d=="function"&&(f=d,d=c,e=null,c="");if(a.client){d=a.resolve(d);if(b[d])return f(null,b[d]);var g=window.blade;if(g.cb[d])throw new Error("Template is already loading. Be patient.");var h=document.createElement("script");h.type="application/javascript",h.async=!0,h.src=g.rootURL+"/"+d;var i=document.getElementsByTagName("script")[0];i.parentNode.insertBefore(h,i);var j=setTimeout(function(){delete g.cb[d],h.parentNode.removeChild(h),f(new Error("Timeout Error: Blade Template ["+d+"] could not be loaded."))},15e3);g.cb[d]=function(a){clearTimeout(j),delete g.cb[d],h.parentNode.removeChild(h),f(null,a[d])}}else{var g=require("./blade");g.compileFile(c+"/"+d,e,function(a,b){if(a)return f(a);f(null,b.template)})}},a.resolve=function(b){if(a.client){var c=document.createElement("div");return c.innerHTML='<a href="'+a.escape("./"+b)+'"></a>',c=c.firstChild.href,c=c.substr(window.location.href.length).replace(/\/\//g,"/"),c.charAt(0)=="/"&&(c=c.substr(1)),c}},a.include=function(b,c,d){function l(a,b){e||(c.inc=!1),c.filename=f,c.base=g,c.rel=h,c.line=i,c.col=j,c.source=k,d(a)}var e=c.inc,f=c.filename,g=c.base,h=c.rel,i=c.line,j=c.col,k=c.source;c.inc=!0;var m=b.split("/");m=m[m.length-1].indexOf("."),m<0&&(b+=".blade"),a.loadTemplate(c.base,c.rel+"/"+b,a.compileOptions,function(a,b){if(a)return d(a);b(c.locals,l,c)})},a.capture=function(a,b){var c=b.pos;for(var d in a.blocks)a.blocks[d].pos>=c&&delete a.blocks[d];return a.splice(c,a.length-c).join("")},a.chunk=function(b,c,d){d.chunk[b]=function(){return a.capture(d,c.apply({pos:d.length},arguments))}},a.blockDef=function(a,b,c){var d=b.blocks[a]={parent:b.block||null,buf:[],pos:b.length,numChildren:0},e=["r","blocks","func","locals","cb"];for(var f in e)d.buf[e[f]]=b[e[f]];return d.buf.block=d,d.parent&&d.parent.numChildren++,b.push(""),c.length>1?d.paramBlock=c:c(d.buf),d},a.blockRender=function(a,b,d){var e=d.blocks[b];if(e==null)throw new Error("Block '"+b+"' is undefined.");if(e.paramBlock==null)throw new Error("Block '"+b+"' is a regular, non-parameterized block, which cannot be rendered.");var f=[e.buf];for(var g=3;g<arguments.length;g++)f[g-2]=arguments[g];a=="r"&&(e.buf.length=0);var h=e.buf.length;e.paramBlock.apply(this,f),a=="p"&&c(e,d,h)},a.blockMod=function(a,b,d,e){var f=d.blocks[b];if(f==null)throw new Error("Block '"+b+"' is undefined.");a=="r"&&(delete f.paramBlock,f.buf.length=0);var g=f.buf.length;e.length>1?f.paramBlock=e:e(f.buf),a=="p"&&c(f,d,g)},a.done=function(a){var b=!1;while(!b){b=!0;for(var c in a.blocks){var d=a.blocks[c];!d.done&&d.numChildren==0&&(b=!1,d.parent==null?a[d.pos]=d.buf.join(""):(d.parent.buf[d.pos]=d.buf.join(""),d.parent.numChildren--),d.done=!0)}}},a.rethrow=function(a,b){b==null&&(b=a);if(a.lastFilename==b.filename&&a.lastFilename!=null)return a;b.column=b.column||b.col;var c=a.message+"\n    at "+(b.filename==null?"<anonymous>":b.filename)+(b.line==null?"":":"+b.line+(b.column==null?"":":"+b.column));if(b.source!=null){const e=3;var f=b.source.split("\n"),g=Math.max(b.line-e,0),h=Math.min(b.line+e,f.length),i=(new String(h)).length;f=f.slice(g,h),c+="\n\n";for(var j=0;j<f.length;j++)c+=d(j+g+1,i)+(j+g+1==b.line?">	":"|	")+f[j]+"\n"}return a.message=c,a.lastFilename=b.filename,a.filename==null&&a.line==null&&(a.filename=b.filename,a.line=b.line,a.column=b.column),a}})();